<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>360Â° Virtual Tour - Multi-Room</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }

    #pano {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
    }

    /* Room Selector (grouped by rooms) */
    #roomSelector {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      border-radius: 12px;
      padding: 12px;
      display: flex;
      gap: 10px;
      max-width: 90%;
      z-index: 10;
      backdrop-filter: blur(10px);
      flex-wrap: wrap;
    }

    .room-button-container {
      position: relative;
    }

    .room-button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      padding: 10px 18px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .room-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    }

    .room-button.active {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      box-shadow: 0 6px 12px rgba(245, 87, 108, 0.4);
    }

    .viewpoint-indicator {
      background: rgba(255, 255, 255, 0.2);
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
    }

    /* Viewpoint Submenu */
    .viewpoint-submenu {
      position: absolute;
      bottom: 100%;
      left: 0;
      margin-bottom: 10px;
      background: rgba(0, 0, 0, 0.9);
      border-radius: 8px;
      padding: 8px;
      display: none;
      flex-direction: column;
      gap: 6px;
      min-width: 150px;
      box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.3);
    }

    .room-button-container:hover .viewpoint-submenu,
    .viewpoint-submenu:hover {
      display: flex;
    }

    .viewpoint-button {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .viewpoint-button:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .viewpoint-button.active {
      background: rgba(102, 126, 234, 0.8);
      border-color: rgba(102, 126, 234, 1);
    }

    .viewpoint-button .checkmark {
      font-size: 10px;
    }

    /* Current Viewpoint Indicator (Top Overlay) */
    #currentViewpoint {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      z-index: 10;
      backdrop-filter: blur(10px);
    }

    #currentViewpoint .room-name {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 4px;
    }

    #currentViewpoint .viewpoint-name {
      font-size: 12px;
      color: rgba(255, 255, 255, 0.8);
    }

    /* Hotspot Styles */
    .hotspot {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 3px solid white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
      font-weight: bold;
      transition: transform 0.2s ease-in-out, background 0.2s ease-in-out;
    }

    .hotspot.room-nav {
      background: rgba(102, 126, 234, 0.9);  /* Purple for room navigation */
    }

    .hotspot.viewpoint-nav {
      background: rgba(52, 211, 153, 0.9);  /* Green for viewpoint switching */
    }

    .hotspot:hover {
      transform: scale(1.3);
    }

    .hotspot.room-nav:hover {
      background: rgba(245, 87, 108, 0.9);  /* Pink on hover */
    }

    .hotspot.viewpoint-nav:hover {
      background: rgba(16, 185, 129, 0.9);  /* Darker green on hover */
    }

    /* Loading */
    #loading {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 100;
      text-align: center;
    }

    .spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top: 4px solid #667eea;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    #loading p {
      color: white;
      margin-top: 15px;
      font-size: 16px;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="loading">
    <div class="spinner"></div>
    <p>Loading Virtual Tour...</p>
  </div>
  <div id="pano"></div>
  <div id="currentViewpoint" style="display: none;">
    <div class="room-name"></div>
    <div class="viewpoint-name"></div>
  </div>
  <div id="roomSelector"></div>

  <script src="/marzipano.js"></script>
  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const propertyId = urlParams.get('propertyId');
    const apiBaseUrl = window.location.origin;

    let viewer;
    let rooms = []; // Array of rooms, each with viewpoints
    let currentRoomId = null;
    let currentViewpointId = null;

    // Initialize viewer
    function initViewer() {
      const panoElement = document.getElementById('pano');
      viewer = new Marzipano.Viewer(panoElement, {
        controls: {
          mouseViewMode: 'drag'
        }
      });
    }

    // Load rooms and viewpoints
    async function loadRoomsData() {
      try {
        const response = await fetch(`${apiBaseUrl}/api/rooms/properties/${propertyId}/rooms`);
        const data = await response.json();
        
        if (data.success && data.data.rooms.length > 0) {
          rooms = data.data.rooms;
          
          // Also fetch scenes to group them
          const scenesResponse = await fetch(`${apiBaseUrl}/api/properties/${propertyId}/scenes`);
          const scenesData = await scenesResponse.json();
          
          if (scenesData.success) {
            // Group scenes by room
            rooms.forEach(room => {
              room.viewpoints = scenesData.data.scenes.filter(s => s.room_id === room.id);
            });
          }
          
          renderRoomSelector();
          
          // Load first room's default viewpoint
          const firstRoom = rooms[0];
          const defaultViewpoint = firstRoom.viewpoints.find(v => v.is_default_viewpoint) || firstRoom.viewpoints[0];
          await loadViewpoint(firstRoom.id, defaultViewpoint.id);
        } else {
          showError('No virtual tour available');
        }
      } catch (error) {
        console.error('Error loading rooms:', error);
        showError('Failed to load virtual tour');
      }
    }

    // Render room selector buttons
    function renderRoomSelector() {
      const selector = document.getElementById('roomSelector');
      selector.innerHTML = '';

      rooms.forEach(room => {
        const container = document.createElement('div');
        container.className = 'room-button-container';

        const button = document.createElement('button');
        button.className = 'room-button';
        button.innerHTML = `
          <span>${room.room_name}</span>
          ${room.id === currentRoomId ? `<span class="viewpoint-indicator">${getCurrentViewpointName()}</span>` : ''}
        `;
        button.onclick = () => {
          const defaultVp = room.viewpoints.find(v => v.is_default_viewpoint) || room.viewpoints[0];
          loadViewpoint(room.id, defaultVp.id);
        };
        
        if (room.id === currentRoomId) {
          button.classList.add('active');
        }

        // Create viewpoint submenu if multiple viewpoints
        if (room.viewpoints.length > 1) {
          const submenu = document.createElement('div');
          submenu.className = 'viewpoint-submenu';
          
          room.viewpoints.forEach(vp => {
            const vpButton = document.createElement('button');
            vpButton.className = 'viewpoint-button';
            if (vp.id === currentViewpointId) {
              vpButton.classList.add('active');
            }
            vpButton.innerHTML = `
              <span>${vp.viewpoint_name}</span>
              ${vp.id === currentViewpointId ? '<span class="checkmark">âœ“</span>' : ''}
            `;
            vpButton.onclick = (e) => {
              e.stopPropagation();
              loadViewpoint(room.id, vp.id);
            };
            submenu.appendChild(vpButton);
          });
          
          container.appendChild(submenu);
        }

        container.appendChild(button);
        selector.appendChild(container);
      });
    }

    function getCurrentViewpointName() {
      const room = rooms.find(r => r.id === currentRoomId);
      if (!room) return '';
      const vp = room.viewpoints.find(v => v.id === currentViewpointId);
      return vp ? vp.viewpoint_name : '';
    }

    // Load a specific viewpoint
    async function loadViewpoint(roomId, viewpointId) {
      try {
        showLoading();
        currentRoomId = roomId;
        currentViewpointId = viewpointId;

        // Fetch full scene data
        const response = await fetch(`${apiBaseUrl}/api/scenes/${viewpointId}`);
        const data = await response.json();

        if (data.success) {
          const sceneData = data.data.scene;
          
          const previewImage = sceneData.images.find(img => img.image_type === 'preview');
          
          if (previewImage) {
            const source = Marzipano.ImageUrlSource.fromString(
              `${apiBaseUrl}/${previewImage.file_path}`
            );

            const geometry = new Marzipano.EquirectGeometry([{ width: 4096 }]);
            const limiter = Marzipano.RectilinearView.limit.traditional(4096, 120 * Math.PI / 180);
            
            const view = new Marzipano.RectilinearView({
              yaw: sceneData.initial_view_yaw,
              pitch: sceneData.initial_view_pitch,
              fov: sceneData.initial_view_fov
            }, limiter);

            const marzipanoScene = viewer.createScene({
              source: source,
              geometry: geometry,
              view: view,
              pinFirstLevel: true
            });

            // Add hotspots
            sceneData.hotspots.forEach(hotspot => {
              addHotspot(marzipanoScene, hotspot);
            });

            marzipanoScene.switchTo({
              transitionDuration: 1000
            });
          }

          updateCurrentViewpointDisplay();
          renderRoomSelector();
          hideLoading();
        }
      } catch (error) {
        console.error('Error loading viewpoint:', error);
        showError('Failed to load viewpoint');
      }
    }

    // Add a hotspot
    function addHotspot(scene, hotspot) {
      const element = document.createElement('div');
      element.className = 'hotspot';
      
      // Determine hotspot type and style
      if (hotspot.is_room_navigation) {
        element.classList.add('room-nav');
        element.innerHTML = 'â†’';
        element.title = hotspot.title || 'Go to room';
      } else {
        element.classList.add('viewpoint-nav');
        element.innerHTML = 'ðŸ‘';
        element.title = hotspot.title || 'Switch viewpoint';
      }

      element.onclick = () => handleHotspotClick(hotspot);

      scene.hotspotContainer().createHotspot(element, {
        yaw: hotspot.yaw,
        pitch: hotspot.pitch
      });
    }

    // Handle hotspot click
    function handleHotspotClick(hotspot) {
      if (hotspot.is_room_navigation && hotspot.target_room_id) {
        // Navigate to another room (use default viewpoint)
        const targetRoom = rooms.find(r => r.id === hotspot.target_room_id);
        if (targetRoom) {
          const defaultVp = targetRoom.viewpoints.find(v => v.is_default_viewpoint) || targetRoom.viewpoints[0];
          loadViewpoint(targetRoom.id, defaultVp.id);
        }
      } else if (hotspot.target_scene_id) {
        // Switch to a different viewpoint (might be same room or different)
        const targetRoom = rooms.find(r => 
          r.viewpoints.some(v => v.id === hotspot.target_scene_id)
        );
        if (targetRoom) {
          loadViewpoint(targetRoom.id, hotspot.target_scene_id);
        }
      }
    }

    // Update current viewpoint display
    function updateCurrentViewpointDisplay() {
      const display = document.getElementById('currentViewpoint');
      const room = rooms.find(r => r.id === currentRoomId);
      if (room) {
        const vp = room.viewpoints.find(v => v.id === currentViewpointId);
        display.querySelector('.room-name').textContent = room.room_name;
        display.querySelector('.viewpoint-name').textContent = vp ? vp.viewpoint_name : '';
        display.style.display = 'block';
      }
    }

    // Loading/Error functions
    function showLoading() {
      document.getElementById('loading').style.display = 'block';
    }

    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
    }

    function showError(message) {
      hideLoading();
      alert(message);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      if (!propertyId) {
        showError('Property ID is missing');
        return;
      }
      initViewer();
      loadRoomsData();
    });
  </script>
</body>
</html>

